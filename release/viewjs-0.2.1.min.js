/**
 * viewjs v0.2.1 (2014-02-15)
 * Copyright (c) 2014, Andreas Tietz
 * Released under the MIT license
 */
!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):View=View||factory(jQuery)}(function($){function View(config){var self=this;return self instanceof View==!1?new View(config):(config=config||{},self.name=config.name,self.bundle=config.bundle,self.isRootView=config.isRootView,self.parentView=config.parentView,self.childViews=config.childViews,self.onViewDidLoad=config.onViewDidLoad,void(self.onViewWillUnload=config.onViewWillUnload))}return View.prototype.extend=function(extension){function PrototypeConstructor(){this.constructor=extension.constructor}var self=this;extension=$.extend({constructor:function(config){self.super.constructor.call(this,config)}},extension);for(var key in self.constructor)({}).hasOwnProperty.call(self.constructor,key)&&(extension.constructor[key]=self.constructor[key]);return PrototypeConstructor.prototype=self.constructor.prototype,extension.constructor.prototype=new PrototypeConstructor,extension.constructor.prototype.super=self.constructor.prototype,$.extend(extension.constructor.prototype,extension),extension.constructor},View.prototype.viewDidLoad=function(){},View.prototype.viewWillUnload=function(){},View.prototype.defineProperty=function(name,accessors){Object.defineProperty(this.constructor.prototype,name,accessors)},View.prototype.defineProperty("name",{get:function(){return this._name},set:function(name){if(this.isLoaded)throw"[View->name] Cannot change property while view is loaded.";this._name=name}}),View.prototype.defineProperty("bundle",{get:function(){return this._bundle},set:function(bundle){if(this.isLoaded)throw"[View->bundle] Cannot change property while view is loaded.";this._bundle=bundle}}),View.prototype.defineProperty("isRootView",{get:function(){return this._isRootView},set:function(isRootView){if(this.isLoaded)throw"[View->isRootView] Cannot change property while view is loaded.";this._isRootView="undefined"!=typeof isRootView?isRootView:!1}}),View.prototype.defineProperty("parentView",{get:function(){return this._parentView},set:function(parentView){if(this.isLoaded)throw"[View->parentView] Cannot change property while view is loaded.";this.isRootView||(this._parentView=parentView,"undefined"!=typeof this._parentView&&this._parentView.childViews.push(this))}}),View.prototype.defineProperty("childViews",{get:function(){return this._childViews||[]},set:function(childViews){var self=this;if(self.isLoaded)throw"[View->childViews] Cannot change property while view is loaded.";self._childViews=self._childViews||[],childViews=childViews||[],$.each(self._childViews,function(index,childView){childView._parentView=void 0}),self._childViews.length=0,$.each(childViews,function(index,childView){childView._parentView=self,self._childViews.push(childView)})}}),View.prototype.defineProperty("onViewDidLoad",{get:function(){return this._onViewDidLoadCallbacks=this._onViewDidLoadCallbacks||$.Callbacks("unique memory"),{subscribe:this._onViewDidLoadCallbacks.add,unsubscribe:this._onViewDidLoadCallbacks.remove}},set:function(subscription){this._onViewDidLoadCallbacks=this._onViewDidLoadCallbacks||$.Callbacks("unique memory"),subscription&&subscription.subscribe&&this._onViewDidLoadCallbacks.add(subscription.subscribe)}}),View.prototype.defineProperty("onViewWillUnload",{get:function(){return this._onViewWillUnloadCallbacks=this._onViewWillUnloadCallbacks||$.Callbacks("unique memory"),{subscribe:this._onViewWillUnloadCallbacks.add,unsubscribe:this._onViewWillUnloadCallbacks.remove}},set:function(subscription){this._onViewWillUnloadCallbacks=this._onViewWillUnloadCallbacks||$.Callbacks("unique memory"),subscription&&subscription.subscribe&&this._onViewWillUnloadCallbacks.add(subscription.subscribe)}}),View.prototype._containerElement,View.prototype._viewElement,View.prototype.defineProperty("isLoaded",{get:function(){return this._viewElement&&this._viewElement.length>0&&this._containerElement&&this._containerElement.length>0}}),View.prototype.$=function(selector){var self=this;if(self.isLoaded)return selector?self._viewElement.find(selector):self._viewElement;if(selector)throw"[View.prototype.$] Error while selecting inner elements of a view: View is not loaded.";return[]},View.prototype.load=function(){var self=this;if(self._parentView&&!self._parentView.isLoaded)throw"[View.prototype.load] Error while loading a view into a container: Parent view is not loaded yet.";if(!self._name)throw"[View.prototype.load] Error while loading a view into a container: Name not specified.";if(!self._bundle)throw"[View.prototype.load] Error while loading a view into a container: (HTML/CSS)-bundle not specified.";if(!self._isRootView&&!self._parentView)throw console.log(self),"[View.prototype.load] Error while loading a view into a container: View detached from view hierarchy. Attempting to load a view that has no parent view. Only root views are allowed to do that.";self.unload();var containerElementSelector="[data-view-name='"+self._name+"']";if(self._containerElement=self._parentView?self._parentView.$(containerElementSelector):$(containerElementSelector),0===self._containerElement.length)throw"[View.prototype.load] Error while loading a view into a container: Container element not specified or not existent.";if(self._containerElement.children().length>0)throw"[View.prototype.load] Error while loading a view into a container: Container is currently occupied by another view. Unload this view explicitly before attempting to load another view into the same container.";if(self._parentView){if(self._containerElement.parents().index(self._parentView._viewElement)<0)throw"[View.prototype.load] Error while loading a view into a container: Container element must be a descendant of the parent view's DOM.";if(self._containerElement.parents().index(self._parentView._viewElement.find("[data-view-container]"))>=0)throw"[View.prototype.load] Error while loading a view into a container: Container element must not be a descendant of any other child view container inside the parent view's DOM."}var viewDidLoad=$.Deferred();return require(["html!"+self._bundle+".html","css!"+self._bundle],function(html){self._viewElement=self._containerElement,self._containerElement=self._containerElement.clone();var $html=$(html);self._viewElement.replaceWith($html),self._viewElement=$html,self._viewElement.addClass(self._containerElement[0].className),self._viewElement.attr("data-view-name",self._containerElement.attr("data-view-name")),self._viewElement.attr("data-view-controller",self.constructor.name),self.viewDidLoad(),self._onViewDidLoadCallbacks.fire(self),viewDidLoad.resolve(self),$.each(self._childViews,function(index,childView){childView.load()})}),viewDidLoad.promise()},View.prototype.unload=function(){var self=this,viewWillUnload=$.Deferred();return self.isLoaded&&($.each(self._childViews,function(index,childView){childView.unload()}),self.viewWillUnload(),self._onViewWillUnloadCallbacks.fire(self),viewWillUnload.resolve(self),self._viewElement.replaceWith(self._containerElement),self._containerElement=void 0,self._viewElement=void 0),viewWillUnload.promise()},View.prototype.toString=function(){var self=this,str=self.constructor.name+(self.constructor.name===self.bundle?"":"/"+self.bundle);return str+=self.isLoaded?" @["+self.name+"]":str+=" @[not loaded]"},View.prototype.traverse=function(fn,level){var self=this;void 0===level&&(level=0),fn(self,level),$.each(self._childViews,function(index,childView){childView.traverse(fn,level+1)})},View.prototype.getViewHierarchyHumanReadable=function(){var self=this,hierarchyOutput="";return self.traverse(function(view,level){for(var i=1;level>i;i++)hierarchyOutput+="|    ";level>0&&(hierarchyOutput+="|--> "),hierarchyOutput+=view+"\n"}),hierarchyOutput},View});